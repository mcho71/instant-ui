# JSONパーサー改善ドキュメント

## 変更の背景
AIレスポンスの処理を簡素化し、純粋なJSON文字列前提でパーサーを再設計しました。

## 実装した変更

### 1. システムプロンプト更新
**ファイル**: `prompts/system.txt`

**変更内容**:
- ```json囲みを削除し、純粋なJSON形式での出力を指示
- AIに対してMarkdownフォーマット不要を明確化

**Before**:
```
必ずJSON形式で以下の構造で回答してください：

```json
{...}
```
```

**After**:
```
必ず純粋なJSON形式のみで回答してください（```jsonで囲まずに）：

{...}
```

### 2. パーサーロジック簡素化
**ファイル**: `src/vertex-ai.js`

**主な変更**:
- ```json囲み検出ロジックを削除
- 純粋なJSON文字列前提でのパーサーに変更
- より効率的な妥当性チェック機能を追加

**新機能**:
- `isValidJSON()`: JSON妥当性の事前チェック
- 改善された`repairPartialJson()`: より堅牢な部分的JSON修復

### 3. エラーハンドリング改善
- 明確なエラーメッセージ
- デバッグ用の詳細ログ出力
- 段階的な修復プロセス

## 技術詳細

### パーサーフロー
1. **入力**: AIからの生のレスポンス文字列
2. **前処理**: トリム処理
3. **妥当性チェック**: `isValidJSON()`で事前確認
4. **修復処理**: 必要に応じて`repairPartialJson()`実行
5. **最終パース**: `JSON.parse()`で最終変換

### 修復機能
- 不完全な行の除去
- 末尾カンマの削除
- 不足した閉じ括弧の補完
- 文字列エスケープの正規化

## 期待される効果
1. **性能向上**: 不要な正規表現処理の削除
2. **信頼性向上**: より堅牢なエラーハンドリング
3. **保守性向上**: シンプルで理解しやすいコード
4. **拡張性**: 新しいフォーマット要件への対応容易

## テスト推奨項目
- [ ] 完全なJSONレスポンスの処理
- [ ] 部分的JSONの修復機能
- [ ] 無効なJSONでのエラーハンドリング
- [ ] トークン制限による途中切断への対応

## 今後の改善案
- キャッシュ機能の追加
- レスポンス圧縮の対応
- バッチ処理機能の実装